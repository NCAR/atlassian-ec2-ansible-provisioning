#!/bin/bash

APP={{ atl_product_edition }}

backupdir=$1
src_site=$2
if test -z $backupdir || ! test -d $backupdir; then
   cat << EOF
Usage: $0 backup_dir [ src_site ]

Restore database and home directory for app "$APP";
backupdir must contain files home.tgz and db.sql.gz

If src_site is given, replace that with the current baseurl
FQDN in the database dump.

THE APPLICATION SHOULD BE STOPPED BEFORE RESTORE!
EOF
exit 1
fi

if systemctl is-active --quiet $APP; then
    echo "Service \"$APP\" is running; must be stopped before restore."
    exit 1
fi

if ! test -e "${backupdir}/home.tgz"; then
    echo "Backup dir is missing file home.tgz"
    exit 1
fi

if ! test -e "${backupdir}/db.sql.gz"; then
    echo "Backup dir is missing file db.sql.gz"
    exit 1
fi

homedir="/var/atlassian/application-data/${APP}"

#
# Restore home directory
#
excludes=$(mktemp)
cat <<EXCLUDES >$excludes
*/confluence.cfg.xml
*/synchrony-args.properties
./temp/*
EXCLUDES

tar -C $homedir -X $excludes-zxf "${backupdir}/home.tgz" .
rm $excludes

#
# Restore database
# FIXME TRANSFORMATIONS
#
database=$(grep hibernate.connection.url $homedir/confluence.cfg.xml | sed -e 's/.*\/\(.*\)<.*/\1/')
dbserver=$(grep hibernate.connection.url $homedir/confluence.cfg.xml | sed -e 's/.*mysql:\/\/\(.*\):.*/\1/')
dbuser=$(grep hibernate.connection.username $homedir/confluence.cfg.xml | sed -e 's/.*username">\(.*\)<.*/\1/')
dbpassword=$(grep hibernate.connection.password $homedir/confluence.cfg.xml | sed -e 's/.*password">\(.*\)<.*/\1/')

mycnf=$(mktemp)
cat <<MYCNF >$mycnf
[client]
host=$dbserver
user=$dbuser
password='$dbpassword'
MYCNF

if test -z $src_site; then
    gunzip < "${backupdir}/db.sql.gz" | mysql --defaults-file=$mycnf $database
else
    # Change the baseurl FQDN in the dump to our current one on restore
    fqdn=$(mysql --defaults-file=/tmp/mycnf -sre "use confluence; select BANDANAVALUE from BANDANA where BANDANACONTEXT = '_GLOBAL' and BANDANAKEY = 'atlassian.confluence.settings';" | perl -ne 'm(\Q<baseUrl>https://\E(.*)>.*) && print $1;')
     gunzip < "${backupdir}/db.sql.gz" |  perl -pe "s/\Q$src_site\E/$fqdn/" | mysql --defaults-file=$mycnf $database
fi
rm $mycnf
