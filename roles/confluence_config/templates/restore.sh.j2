#!/bin/bash

APP={{ atl_product_edition }}

backupdir=$1
if test -z $backupdir || ! test -d $backupdir; then
   cat << EOF
Usage: $0 backupdir

Restore database and home directory for app "$APP";
backupdir must contain files home.tgz and db.sql.gz

THE APPLICATION SHOULD BE STOPPED BEFORE RESTORE!
EOF
exit 1
fi

if ! test -e "${backupdir}/home.tgz"; then
    echo "Backup dir is missing file home.tgz"
    exit 1
fi

if ! test -e "${backupdir}/db.sql.gz"; then
    echo "Backup dir is missing file db.sql.gz"
    exit 1
fi

homedir="/var/atlassian/application-data/${APP}"

#
# Restore home directory
#
tar -C $homedir -zxf "${backupdir}/home.tgz" .

#
# Restore database
#
database=$(grep hibernate.connection.url $homedir/confluence.cfg.xml | sed -e 's/.*\/\(.*\)<.*/\1/')
dbserver=$(grep hibernate.connection.url $homedir/confluence.cfg.xml | sed -e 's/.*mysql:\/\/\(.*\):.*/\1/')
dbuser=$(grep hibernate.connection.username $homedir/confluence.cfg.xml | sed -e 's/.*username">\(.*\)<.*/\1/')
dbpassword=$(grep hibernate.connection.password $homedir/confluence.cfg.xml | sed -e 's/.*password">\(.*\)<.*/\1/')

mycnf=$(mktemp)
cat <<EOF >$mycnf
[client]
host=$dbserver
user=$dbuser
password='$dbpassword'
EOF

gunzip < "${backupdir}/db.sql.gz" | mysql --defaults-file=$mycnf $database

rm $mycnf
