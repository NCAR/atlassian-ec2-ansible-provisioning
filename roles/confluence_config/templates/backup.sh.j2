#!/bin/bash

# GRANT RELOAD, PROCESS ON *.* TO 'confluenceuser'@'%';
# GRANT SHOW_ROUTINE ON *.* TO 'confluenceuser'@'%';

APP={{ atl_product_edition }}
BACKUPROOT=/var/atlassian/application-data/backup

backupdir="${BACKUPROOT}/$(date +'%Y-%m-%dT%H:%M:%S%:z')"
mkdir -p $backupdir
echo "Backing up to ${backupdir}/"

homedir="/var/atlassian/application-data/${APP}"

#
# Backup home directory
#
tar -C $homedir --exclude='./logs/*' -zcf "${backupdir}/home.tgz" .

#
# Backup database
#
database=$(grep hibernate.connection.url $homedir/confluence.cfg.xml | sed -e 's/.*\/\(.*\)<.*/\1/')
dbserver=$(grep hibernate.connection.url $homedir/confluence.cfg.xml | sed -e 's/.*mysql:\/\/\(.*\):.*/\1/')
dbuser=$(grep hibernate.connection.username $homedir/confluence.cfg.xml | sed -e 's/.*username">\(.*\)<.*/\1/')
dbpassword=$(grep hibernate.connection.password $homedir/confluence.cfg.xml | sed -e 's/.*password">\(.*\)<.*/\1/')

mycnf=$(mktemp)
cat <<EOF >$mycnf
[client]
host=$dbserver
user=$dbuser
password='$dbpassword'
EOF

mysqldump --defaults-file=$mycnf \
	  --add-drop-table \
	  --create-options \
	  --disable-keys \
	  --events \
	  --extended-insert \
	  --max_allowed_packet=512M \
	  --quick \
	  --quote-names \
	  --routines \
	  --set-charset \
	  --set-gtid-purged=OFF \
	  --single-transaction \
	  --triggers \
	  $database > "${backupdir}/db.sql"

gzip "${backupdir}/db.sql"

rm $mycnf
